<!DOCTYPE html>
<!--
    Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
    <head>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="viewport" content="user-scalable=no, width=device-width" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <title>Ortho</title>
<style>
body, html { margin: 0px;}
    canvas {
        position:absolute;
        margin:0;
    }
</style>
<script type="text/javascript" charset="utf-8">

    var glyphNames = [
    "CAT0","DOG1","RABBITZ","PRUNE","APPLE9",
    "CAT1","DOG2","RABBITA","PRUNE","APPLE9",
    "CAT2","DOG3","RABBITB","PRUNE","APPLE9",
    "CAT3","DOG4","RABBITC","PRUNE","APPLE9",
    "CAT4","DOG5","RABBITD","PRUNE","APPLE9",
    "CAT5","DOG6","RABBITE","PRUNE","APPLE9",
    ];

    var sketchBookIndex=0;
    var sketchBook=[
    {
        elements:[],
        lines:[],
        offsetX:0,
        offsetY:0,
        scale:1,
        sketchTitle:""
    }
    ];

    function SaveState(){
        var sketch_save = JSON.stringify({book:sketchBook,page:sketchBookIndex});
        localStorage.setItem("sketchbookDat",sketch_save);
    }
    function TryRestoreState(){
        var sketch_save = localStorage.getItem("sketchbookDat");
        if (sketch_save!==null){
            var dat = JSON.parse(sketch_save);
            sketchBook=dat.book;
            sketchBookIndex=dat.page;
            LoadPage();
        }
    }

    var page=sketchBook[0];

    var canvas;

    var id;
    var d;                        // only do this once per page
    var ctx;
    var shapeCount=5;
    var offsetX=0;
    var offsetY=0;
    var scale=1;

    var scaleMin=0.25;
    var scaleMax=1.0;
    var iconSelect=false;
    var toolbarSelect=false;

    function doStart(){
        canvas = document.getElementById("mainCanvas");
        ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        canvas.addEventListener("touchstart", handleStart, false);
        canvas.addEventListener("touchend", handleEnd, false);
        canvas.addEventListener("touchcancel", handleEnd, false);
        canvas.addEventListener("touchleave", handleEnd, false);
        canvas.addEventListener("touchmove", handleMove, false);
        TryRestoreState();

        render();
    }

    var hx=0;
    var hy=0;
    var oldX=0;
    var oldY=0;
    var oldtouches=null;
    var cleared=false;
    var moved=false;

    function LoadPage(){
        if(sketchBookIndex===sketchBook.length){
            sketchBook.push({
                elements:[],
                lines:[],
                offsetX:0,
                offsetY:0,
                scale:1,
                sketchTitle:""
            });
        }
        page=sketchBook[sketchBookIndex];
        render();
    }
    function PageLeft(){
        if (sketchBookIndex===0){
            return;
        }
        sketchBookIndex--;  
        LoadPage();      
        SaveState();
    }

    function PageEmpty(){
        return page.lines.length===0&&page.elements.length===0;
    }
    function PageRight(){
        if (PageEmpty()===false){
            sketchBookIndex++;
            LoadPage();
            SaveState();
        }
    }

    function clearEverything(){        
        sketchBook.splice(sketchBookIndex,1);
        if (sketchBookIndex===sketchBook.length &&
            sketchBookIndex>0){
            sketchBookIndex--;
        }
        LoadPage();
    }

    function iconAt(tx,ty){
        for (var i=0;i<page.elements.length;i++){
            var el = page.elements[i];
            if (el[0]===tx&&el[1]===ty){
                return true;
            }
        }
        return false;
    }
var mousex=0;
var mousey=0;
var startPosX=0;
var startPosY=0;
    function handleStart(evt) {

        console.log("handleStart\t"+evt.touches.length+"\t"+toolbarSelect);
        if (iconSelect==true){
            iconSelect=false;
        }
        evt.preventDefault();

        if (evt.touches.length===2){
            moved=true;
            oldtouches=[evt.touches[0].clientX,evt.touches[0].clientY,evt.touches[1].clientX,evt.touches[1].clientY];
        } 
       if (evt.touches.length===1){

            var t= evt.changedTouches[0];

            var cx = t.clientX-page.offsetX;
            var cy = t.clientY-page.offsetY;

            if (t.clientY<cellSize+20){

                toolbarSelect=true;
                console.log("toolbarSelect = "+toolbarSelect);

                if (t.clientX<cellSize){
                    //delete
                    clearEverything();
                } else if (t.clientX<canvas.width-2*cellSize){
                    //set title
                    newTitle();
                } else if (t.clientX<canvas.width-cellSize){
                    //move left
                    PageLeft();
                } else {
                    //move right
                    PageRight();
                }
                render();
                return;
            }
            oldtouches=[evt.touches[0].clientX,evt.touches[0].clientY,evt.touches[0].clientX,evt.touches[0].clientY];

            var gx = Math.round(cx/(cellSize*page.scale));
            var gy = Math.round(cy/(cellSize*page.scale));
            mousex=t.clientX;
            mousey=t.clientY;
            var iconat = iconAt(gx,gy);
            if (!iconat){
                startPosX=mousex;
                startPosY=mousey;
                iconSelect=true;
                minDistHit=false;
            }
            oldX=gx;
            oldY=gy;           
        }

        render();
    }


    function newTitle(){        
        var onSucess = function(){};
        var s = prompt("enter title",page.sketchTitle).toUpperCase();
        if (s.length>5){
            s=s.substr(0,5);
        }
        page.sketchTitle=s;
        SaveState();
    }
    function clickCell(x,y,n){
        for (var i=0;i<page.elements.length;i++){
            var e = page.elements[i];
            if (e[0]===x&&e[1]===y){
                page.elements.splice(i,1);
                break;
            }
        }
        page.elements.push([x,y,n]);
        SaveState();
    }

    function tryRemoveCell(x,y){
        for (var i=0;i<page.elements.length;i++){
            var e = page.elements[i];
            if (e[0]===x&&e[1]===y){
                if (e[2]<shapeCount-1){
                    e[2]++;
                } else {
                    page.elements.splice(i,1);
                }
                break;
            }
        }   

        for (var i=0;i<page.lines.length;i++){
            var l = page.lines[i];
            var x1=l[0];
            var y1=l[1];
            var x2=l[2];
            var y2=l[3];
            if (x1===x&&y1===y){
                if (!iconAt(x2,y2)){
                    page.lines.splice(i,1);
                    i--;
                }
            } else if (x2===x&&y2===y){
                if (!iconAt(x1,y1)){
                    page.lines.splice(i,1);
                    i--;
                }
            }
        }
        SaveState();
    }

    function makeLine(x1,y1,x2,y2){
        /*if (x2>x1+1){
            x2=x1+1;
        } else if (x2<x1-1){
            x2=x1-1;
        }
        if (y2>y1+1){
            y2=y1+1;
        } else if (y2<y1-1){
            y2=y1-1;
        }*/


        var dx=x2-x1;
        var dy=y2-y1;

        var l = Math.max(Math.abs(dx),Math.abs(dy));
        dx = Math.sign(dx)*l;
        dy = Math.sign(dy)*l;
        x2=x1+dx;
        y2=y1+dy;

        if (x1<x2|| (x1===x2&&y1<y2)){
            var tx=x1;
            x1=x2;
            x2=tx;

            var ty=y1;
            y1=y2;
            y2=ty;
        }

        for (var i=0;i<page.lines.length;i++){
            var l = page.lines[i];
            if (l[0]===x1&&l[1]===y1&&l[2]===x2&&l[3]===y2) {
                if (l[4]===0){
                    l[4]=1;
                } else {
                    page.lines.splice(i,1);
                }
                return;
            }
        }

        page.lines.push([x1,y1,x2,y2,0]);
        SaveState();
    }


    function handleEnd(evt){
        console.log("handleEnd\t"+evt.touches.length+"\t"+toolbarSelect);
        evt.preventDefault();
        if (cleared===true || moved===true || toolbarSelect===true){
            if (evt.touches.length===0){
                cleared=false;
                moved=false;
                toolbarSelect=false;
                console.log("toolbarSelect = "+toolbarSelect);
            }
            render();
            return;

        }

        if (page.scale<=scaleMin){
            render();
            return;
        }

        if (evt.touches.length==0){
            if (iconSelect&&minDistHit){
                var t = evt.changedTouches[0];
                var px = t.clientX;
                var py = t.clientY;
                drawSelectionPanel(true,px,py);
                iconSelect=false;
                render();
                return;
            }
        }

        for (var i=0;i<evt.changedTouches.length;i++){

            var t= evt.changedTouches[i];

            var cx = t.clientX-page.offsetX;
            var cy = t.clientY-page.offsetY;

            var gx = Math.round(cx/(cellSize*page.scale));
            var gy = Math.round(cy/(cellSize*page.scale));

            if (oldX==gx && oldY==gy){
                tryRemoveCell(gx,gy);
            } else {
                makeLine(oldX,oldY,gx,gy);
            }
        }
        render();
    }
    var pentagon = [
        0,-1000,
        -951,-309,
        -588,809,
        588,809,
        951,-309
    ];

    var triangle = [
        0,-1000,
        -866,500,
        866,500
    ];

    function drawIcon(x,y,n){
                ctx.fillStyle="#ffffff"
                ctx.strokeStyle="#000000"
        switch(n){
            case 0: // good/bad yinyang
            {
                var r = cellSize*0.4*page.scale;
                ctx.beginPath();
                ctx.arc(x,y,r,Math.PI/2,Math.PI/2+2*Math.PI);
                ctx.fillStyle="#000000"
                ctx.fill();                

                ctx.beginPath();
                ctx.arc(x,y,r,Math.PI/2+Math.PI/2,Math.PI/2+3*Math.PI/2);
                ctx.fillStyle="#ffffff"
                ctx.fill();


                ctx.beginPath();
                ctx.arc(x+r/2,y,r/2,Math.PI/2+0,Math.PI/2+2*Math.PI);
                ctx.fillStyle="#000000"
                ctx.fill();
                

                ctx.beginPath();
                ctx.arc(x-r/2,y,r/2,Math.PI/2+0,Math.PI/2+2*Math.PI);
                ctx.fillStyle="#ffffff"
                ctx.fill();

                ctx.beginPath();
                ctx.arc(x,y,r,Math.PI/2+0,Math.PI/2+2*Math.PI);
                ctx.strokeStyle="#000000"      
                ctx.stroke();

                break;
            }
            case 1: //inside/outside box in box
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.3;
                ctx.moveTo(x-s,y-s);
                ctx.lineTo(x+s,y-s);
                ctx.lineTo(x+s,y+s);
                ctx.lineTo(x-s,y+s);
                ctx.closePath();
                s*=0.66;
                ctx.moveTo(x-s,y-s);
                ctx.lineTo(x+s,y-s);
                ctx.lineTo(x+s,y+s);
                ctx.lineTo(x-s,y+s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 2: // part/many division
            {
                ctx.beginPath();
                var r = cellSize*0.4*page.scale;
                ctx.arc(x,y,r,0,2*Math.PI);
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.moveTo(x-r,y);
                ctx.lineTo(x+r,y);
                ctx.strokeStyle="#000000"
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(x,y-r/2,1,0,2*Math.PI);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(x,y+r/2,1,0,2*Math.PI);
                ctx.stroke();
                break;   
            }
            case 3: // temperature (lines coming in from outside)
            {
                ctx.beginPath();
                var r = cellSize*0.4*page.scale;
                ctx.arc(x,y,r,0,2*Math.PI);
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.moveTo(x-r,y);
                ctx.lineTo(x-r/2,y);
                ctx.moveTo(x,y-r);
                ctx.lineTo(x,y-r/2);
                ctx.moveTo(x+r,y);
                ctx.lineTo(x+r/2,y);
                ctx.moveTo(x,y+r);
                ctx.lineTo(x,y+r/2);
                ctx.stroke();
                break;   
            }
            case 4://desire spiral
            {
                var r = cellSize*0.4*page.scale;
                ctx.beginPath();
                ctx.arc(x,y,r,0,2*Math.PI);
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();          
                ctx.beginPath();
                var r2=r*2/3;
                var r3=r2/2;
                ctx.arc(x,y+r-r2-r3,r3,Math.PI/2,Math.PI*3/2);
                ctx.arc(x,y+r-r2,r2,3*Math.PI/2,Math.PI/2);
                ctx.arc(x,y,r,Math.PI/2,2*Math.PI);
                ctx.stroke();

                break;
            }
            case 5://knowledge - page
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1.41;
                ctx.moveTo(x-s,y-s);
                ctx.lineTo(x+s,y-s);
                ctx.lineTo(x+s,y+s);
                ctx.lineTo(x-s,y+s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.moveTo(x-s*2/3,y-s/2);
                ctx.lineTo(x+s*2/3,y-s/2);
                ctx.moveTo(x-s*2/3,y);
                ctx.lineTo(x+s*2/3,y);
                ctx.moveTo(x-s*2/3,y+s/2);
                ctx.lineTo(x+s*2/3,y+s/2);
                ctx.stroke();
                break;   
            }
            case 6://place, marker
            {
                var r = cellSize*0.4*page.scale*0.9;
                ctx.beginPath();
                ctx.moveTo(x,y+r);
                ctx.lineTo(x-r/2,y);
                ctx.bezierCurveTo(x-r,y-r,x+r,y-r,x+r/2,y);
                //ctx.lineTo(x+r/4,y-2*r);
                ctx.closePath();
                ctx.fillStyle="#000000"
                ctx.fill();
                ctx.fillStyle="#ffffff"
                break;               
            }
            case 7://size arrows
            {
                ctx.beginPath();
                var r = cellSize*0.4*page.scale
                ctx.lineWidth = 2.0;      
                ctx.beginPath();
                ctx.moveTo(x-r,y-r/3);
                ctx.lineTo(x-r,y+r/3);
                ctx.moveTo(x+r,y-r/3);
                ctx.lineTo(x+r,y+r/3);
                ctx.moveTo(x-r/3,y-r);
                ctx.lineTo(x+r/3,y-r);
                ctx.moveTo(x-r/3,y+r);
                ctx.lineTo(x+r/3,y+r);
                ctx.moveTo(x-r,y);
                ctx.lineTo(x+r,y);
                ctx.moveTo(x,y-r);
                ctx.lineTo(x,y+r);
                ctx.stroke();
                ctx.lineWidth = 1.0;      
                break;   
            }
            case 8://height arrows
            {
                ctx.beginPath();
                ctx.lineWidth = 2.0;      
                var r = cellSize*0.4*page.scale
                ctx.beginPath();
                ctx.moveTo(x-r/3,y-r);
                ctx.lineTo(x+r/3,y-r);
                ctx.moveTo(x-r/3,y+r);
                ctx.lineTo(x+r/3,y+r);
                ctx.moveTo(x,y-r);
                ctx.lineTo(x,y+r);
                ctx.stroke();
                ctx.lineWidth = 1.0;      
                break;   
            }
            case 9://speaker thick dot
            {
                ctx.beginPath();
                ctx.arc(x,y,5*page.scale,0,2*Math.PI);   
                ctx.fillStyle="#000000";
                ctx.fill();
                ctx.fillStyle="#ffffff"
                break;   
            }
            /*ugly star
            case 10://object/life thick dot
            {   
                ctx.lineWidth = 2.0;      
                var r = cellSize*0.4*page.scale                  
                ctx.beginPath();
                ctx.moveTo(x,y-r); 
                ctx.lineTo(x,y+r);
                ctx.moveTo(x-r,y); 
                ctx.lineTo(x+r,y);  
                ctx.moveTo(x-r/1.4,y-r/1.4); 
                ctx.lineTo(x+r/1.4,y+r/1.4);  
                ctx.moveTo(x-r/1.4,y+r/1.4); 
                ctx.lineTo(x+r/1.4,y-r/1.4);  
                ctx.stroke();   
                ctx.lineWidth = 1.0;                        
                break;   
            }
            */   
            case 10://hourglass
            {
                ctx.beginPath();
                var r = cellSize*page.scale*0.4;
                var s = cellSize*page.scale*0.4;
                var t = cellSize*page.scale*0.05;
                ctx.moveTo(x-s,y-r);
                ctx.bezierCurveTo(x,y-t,x,y-t,x+s,y-r);    
                ctx.bezierCurveTo(x+t,y,x+t,y,x+s,y+r);
                ctx.bezierCurveTo(x,y+t,x,y+t,x-s,y+r); 
                ctx.bezierCurveTo(x-t,y,x-t,y,x-s,y-r);
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }  

            case 11://loudness concentric circles
            {   
                var r = cellSize*0.4*page.scale;
                var oldR=r;
                ctx.beginPath();
                ctx.arc(x,y,r,0,2*Math.PI);
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();

                r-=oldR*0.333;
                ctx.beginPath();
                ctx.arc(x,y,r,0,2*Math.PI);
                ctx.fill();
                ctx.stroke();

                r-=oldR*0.333;
                ctx.beginPath();
                ctx.arc(x,y,r,0,2*Math.PI);
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 12://see - eye
            {
                var r = cellSize*0.4*page.scale;


                ctx.beginPath();
                ctx.moveTo(x-r,y);
                var top=r*0.8;
                ctx.bezierCurveTo(x-r/2,y-top,x+r/2,y-top,x+r,y);
                ctx.bezierCurveTo(x+r/2,y+top,x-r/2,y+top,x-r,y);
                ctx.fill();
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(x,y,r/4,0,2*Math.PI);
                ctx.stroke();
                break;   
            }
            case 13://hear - ear
            {
                var r = cellSize*0.4*page.scale;


                ctx.beginPath();
                ctx.moveTo(x,y-r);
                var top=r*0.8;
                ctx.bezierCurveTo(x-top,y-r/2,x-top,y+r/2,x,y+r);
                ctx.bezierCurveTo(x+top,y+r/2,x+top,y-r/2,x,y-r);
                ctx.fill();
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(x,y,r/5,0,2*Math.PI);
                ctx.fillStyle="#000000"
                ctx.fill();
                ctx.fillStyle="#ffffff"
                break;   
            }
            case 14://touch - hand
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1.41;
                ctx.moveTo(x-s*0.8,y-2*s+s/2);
                ctx.lineTo(x-s*0.8,y+s);
                ctx.lineTo(x+s*0.8,y+s);
                ctx.lineTo(x+s*0.8,y-s/2);
                ctx.lineTo(x-s/4,y-s+s/2);
                ctx.lineTo(x-s/4,y-2*s+s/2);
                ctx.bezierCurveTo(x-s/4,y-2*s+s/2-s/2,x-s*0.8,y-2*s+s/2-s/2,x-s*0.8,y-2*s+s/2);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 15://smell - nose
            {
                var r = cellSize*0.4*page.scale*0.9;
                ctx.beginPath();
                ctx.moveTo(x-r/4,y-r);
                ctx.lineTo(x-r/2,y);
                ctx.bezierCurveTo(x-r,y+r,x+r,y+r,x+r/2,y);
                ctx.lineTo(x+r/4,y-r);
                //ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 16://talk - mouth
            {
                ctx.fillStyle="#ffffff"
                ctx.strokeStyle="#000000"
                var r = cellSize*0.4*page.scale;
                ctx.beginPath();
                ctx.moveTo(x-r,y);
                var top=r*0.8;
                ctx.bezierCurveTo(x-r/2,y-1.5*top,x+r/2,y-1.5*top,x+r,y);
                ctx.bezierCurveTo(x+r/2,y+1.5*top,x-r/2,y+1.5*top,x-r,y);
                ctx.fill();
                ctx.bezierCurveTo(x-r/2,y-top,x+r/2,y-top,x+r,y);
                ctx.bezierCurveTo(x+r/2,y+top,x-r/2,y+top,x-r,y);
                ctx.stroke();
                break;   
            }
            case 17://eat - mouth
            {
                var r = cellSize*0.4*page.scale;
                ctx.beginPath();
                ctx.moveTo(x-r,y);
                var top=r*0.8;
                ctx.bezierCurveTo(x-r/2,y-top,x+r/2,y-top,x+r,y);
                ctx.bezierCurveTo(x+r/2,y+top,x-r/2,y+top,x-r,y);
                ctx.fill();
                ctx.lineTo(x+r,y);

                ctx.moveTo(x,y-r/2);
                ctx.lineTo(x,y+r/2);
                ctx.moveTo(x-r/2,y-r/3);
                ctx.lineTo(x-r/2,y+r/3);
                ctx.moveTo(x+r/2,y-r/3);
                ctx.lineTo(x+r/2,y+r/3);
                ctx.stroke();
                break;   
            }

            case 18: // sex - 2 part
            {
                ctx.beginPath();
                var r = cellSize*0.3*page.scale;
                ctx.arc(x,y,r,0,2*Math.PI);
                ctx.fillStyle="#ffffff"
                ctx.strokeStyle="#000000"
                ctx.fill();
                ctx.moveTo(x,y-r);
                ctx.lineTo(x,y+r);
                ctx.stroke();
                break;   
            }
            case 19://perform - star
            {

                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1000;
                ctx.moveTo(x+pentagon[2*0+0]*s,y+pentagon[2*0+1]*s);
                ctx.lineTo(x+pentagon[2*2+0]*s,y+pentagon[2*2+1]*s);
                ctx.lineTo(x+pentagon[2*4+0]*s,y+pentagon[2*4+1]*s);
                ctx.lineTo(x+pentagon[2*1+0]*s,y+pentagon[2*1+1]*s);
                ctx.lineTo(x+pentagon[2*3+0]*s,y+pentagon[2*3+1]*s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 19://perform - star
            {

                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1000;
                ctx.moveTo(x+pentagon[2*0+0]*s,y+pentagon[2*0+1]*s);
                ctx.lineTo(x+pentagon[2*2+0]*s,y+pentagon[2*2+1]*s);
                ctx.lineTo(x+pentagon[2*4+0]*s,y+pentagon[2*4+1]*s);
                ctx.lineTo(x+pentagon[2*1+0]*s,y+pentagon[2*1+1]*s);
                ctx.lineTo(x+pentagon[2*3+0]*s,y+pentagon[2*3+1]*s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }   
            case 20://pronoun 1 - triangle
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1000;
                ctx.moveTo(x+triangle[2*0+0]*s,y+triangle[2*0+1]*s);
                ctx.lineTo(x+triangle[2*2+0]*s,y+triangle[2*2+1]*s);
                ctx.lineTo(x+triangle[2*1+0]*s,y+triangle[2*1+1]*s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;  
            }    
            case 21://pronoun 2 - upside down triangle
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1000;
                ctx.moveTo(x+triangle[2*0+0]*s,y-triangle[2*0+1]*s);
                ctx.lineTo(x+triangle[2*2+0]*s,y-triangle[2*2+1]*s);
                ctx.lineTo(x+triangle[2*1+0]*s,y-triangle[2*1+1]*s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;  
            }  
            case 22://pronoun 3 - square
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1.41;
                ctx.moveTo(x-s,y-s);
                ctx.lineTo(x+s,y-s);
                ctx.lineTo(x+s,y+s);
                ctx.lineTo(x-s,y+s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }   
            case 23://pronoun 3 - diamond
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.4;
                ctx.moveTo(x-s,y);
                ctx.lineTo(x,y+s);
                ctx.lineTo(x+s,y);
                ctx.lineTo(x,y-s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }          
            case 24://if - lambda
            {
                var r=cellSize*0.4*page.scale;
                ctx.beginPath();
                ctx.arc(x,y,r,0,2*Math.PI);
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.moveTo(x-r/1.414,y+r/1.414);
                ctx.lineTo(x+r/1.414,y-r/1.414);
                ctx.moveTo(x+r/1.414,y+r/1.414);
                ctx.lineTo(x,y);
                ctx.stroke();
                break;   
            }      
            case 25://liquid - drop
            {
                var r = cellSize*0.4*page.scale*0.9;
                ctx.beginPath();
                ctx.moveTo(x,y-r);
                ctx.lineTo(x-r/2,y);
                ctx.bezierCurveTo(x-r,y+r,x+r,y+r,x+r/2,y);
                //ctx.lineTo(x+r/4,y-r);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 26://solid - square
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.3/1.41;
                ctx.moveTo(x-s,y-s);
                ctx.lineTo(x+s,y-s);
                ctx.lineTo(x+s,y+s);
                ctx.lineTo(x-s,y+s);
                ctx.closePath();
                ctx.fillStyle="#000000"
                ctx.fill();
                ctx.fillStyle="#ffffff"
                break;   
            }
            case 27://gas - square
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.2/1.41;
                ctx.moveTo(x-s,y-s);
                ctx.bezierCurveTo(x-2*s,y-3*s,x+2*s,y-3*s,x+s,y-s);
                ctx.bezierCurveTo(x+3*s,y-2*s,x+3*s,y+2*s,x+s,y+s);
                ctx.bezierCurveTo(x+2*s,y+3*s,x-2*s,y+3*s,x-s,y+s);
                ctx.bezierCurveTo(x-3*s,y+2*s,x-3*s,y-2*s,x-s,y-s);
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 28://curvature
            {
                ctx.beginPath();
                ctx.arc(x,y,cellSize*0.3*page.scale,0,2*Math.PI);
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 29://knowledge interlocking circles
            {
                ctx.beginPath();
                var r = cellSize*0.3*page.scale
                ctx.arc(x-r/2,y,r,0,2*Math.PI);
                ctx.arc(x+r/2,y,r,0,2*Math.PI);
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.beginPath();                
                ctx.arc(x-r/2,y,r,0,2*Math.PI);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(x+r/2,y,r,0,2*Math.PI);
                ctx.stroke();
                break;   
            }/*
            case 29://competition
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.3;
                ctx.moveTo(x-s,y-s);
                ctx.bezierCurveTo(x-2*s,y+s,x+2*s,y+s,x+s,y-s);
                ctx.bezierCurveTo(x-s,y-2*s,x-s,y+2*s,x+s,y+s);
                ctx.bezierCurveTo(x+2*s,y-s,x-2*s,y-s,x-s,y+s);
                ctx.bezierCurveTo(x+s,y+2*s,x+s,y-2*s,x-s,y-s);
                ctx.fill();
                ctx.stroke();
                break;   
            }*/
            case 1://circle
            {
                ctx.beginPath();
                ctx.arc(x,y,cellSize*0.2*page.scale,0,2*Math.PI);
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 2://star
            {

                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1000;
                ctx.moveTo(x+pentagon[2*0+0]*s,y+pentagon[2*0+1]*s);
                ctx.lineTo(x+pentagon[2*2+0]*s,y+pentagon[2*2+1]*s);
                ctx.lineTo(x+pentagon[2*4+0]*s,y+pentagon[2*4+1]*s);
                ctx.lineTo(x+pentagon[2*1+0]*s,y+pentagon[2*1+1]*s);
                ctx.lineTo(x+pentagon[2*3+0]*s,y+pentagon[2*3+1]*s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 3://triangle
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1000;
                ctx.moveTo(x+triangle[2*0+0]*s,y+triangle[2*0+1]*s);
                ctx.lineTo(x+triangle[2*2+0]*s,y+triangle[2*2+1]*s);
                ctx.lineTo(x+triangle[2*1+0]*s,y+triangle[2*1+1]*s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 4://2 star
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1.41;
                ctx.moveTo(0.5+x-s,0.5+y);
                ctx.lineTo(0.5+x+s,0.5+y);
                ctx.moveTo(0.5+x,0.5+y-s);
                ctx.lineTo(0.5+x,0.5+y+s);
                ctx.moveTo(0.5+x-s/1.414,0.5+y-s/1.414);
                ctx.lineTo(0.5+x+s/1.414,0.5+y+s/1.414);
                ctx.moveTo(0.5+x-s/1.414,0.5+y+s/1.414);
                ctx.lineTo(0.5+x+s/1.414,0.5+y-s/1.414);
                ctx.strokeStyle="#000000"
                ctx.stroke();
                break;   
            }
            case 5://square
            {
                ctx.beginPath();
                var s = cellSize*page.scale*0.4/1.41;
                ctx.moveTo(x-s,y-s);
                ctx.lineTo(x+s,y-s);
                ctx.lineTo(x+s,y+s);
                ctx.lineTo(x-s,y+s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.fill();
                ctx.stroke();
                break;   
            }
            case 30://left button
            {
                ctx.lineWidth=2;
                ctx.beginPath();
                var s = cellSize/3;
                ctx.moveTo(x+s,y);
                ctx.lineTo(x-s,y);
                ctx.lineTo(x-s/2,y-s);
                ctx.moveTo(x-s,y);
                ctx.lineTo(x-s/2,y+s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.stroke();
                ctx.lineWidth=1;
                break;   
            }
            case 31://right button
            {
                ctx.lineWidth=2;
                ctx.beginPath();
                var s = -cellSize/3;
                ctx.moveTo(x+s,y);
                ctx.lineTo(x-s,y);
                ctx.lineTo(x-s/2,y-s);
                ctx.moveTo(x-s,y);
                ctx.lineTo(x-s/2,y+s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.stroke();
                ctx.lineWidth=1;
                break;     
            }
            case 32://delete button
            {
                ctx.lineWidth=2;
                ctx.beginPath();
                var s = cellSize/3;
                ctx.moveTo(x+s,y+s);
                ctx.lineTo(x-s,y-s);
                ctx.moveTo(x+s,y-s);
                ctx.lineTo(x-s,y+s);
                ctx.closePath();
                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.stroke();
                ctx.lineWidth=1;
                break;   
            }
            case 33://new icon
            {
                ctx.lineWidth=2;
                ctx.beginPath();
                var s = cellSize/3;
                var t = 0.2*s;
                ctx.moveTo(x-s,y-s);
                ctx.lineTo(x+t,y-s);
                ctx.lineTo(x+s,y-t);
                ctx.lineTo(x+s,y+s);
                ctx.lineTo(x-s,y+s);
                ctx.closePath();
                ctx.moveTo(x+t,y-s);
                ctx.lineTo(x+t,y-t);
                ctx.lineTo(x+s,y-t);

                ctx.strokeStyle="#000000"
                ctx.fillStyle="#ffffff"
                ctx.stroke();


                ctx.lineWidth=1;
                break;     
            }
        }
    }

    function handleCancel(evt) {
    }

    function dist(ar){
        var dx = ar[2]-ar[0];
        var dy = ar[3]-ar[1];
        return Math.sqrt(dx*dx+dy*dy);
    }

    var moving=false;
    var minDist=5.0;
    var minDistHit=false;
    function handleMove(evt) {
    
        evt.preventDefault();

        if (cleared==true){
            return;
        }
        if (evt.touches.length===1&&page.scale>scaleMin){  
            var t = evt.touches[0];          
            mousex=t.clientX;
            mousey=t.clientY;
            var d = dist([startPosX,startPosY,mousex,mousey]);
            if (iconSelect&& d>minDist){
                minDistHit=true;
            }
            render();
        }

        if (evt.touches.length===2||(evt.touches.length==1&&page.scale<=scaleMin)){
            var curtouches = evt.touches.length===2 ?
                    [evt.touches[0].clientX,evt.touches[0].clientY,evt.touches[1].clientX,evt.touches[1].clientY] :
                    [evt.touches[0].clientX,evt.touches[0].clientY,evt.touches[0].clientX,evt.touches[0].clientY];
                    
            if (oldtouches===null){
                oldtouches=curtouches;
                return;
            }


            var oldCenterX = (oldtouches[0]+oldtouches[2])/2;
            var oldCenterY = (oldtouches[1]+oldtouches[3])/2;
            var curCenterX = (curtouches[0]+curtouches[2])/2;
            var curCenterY = (curtouches[1]+curtouches[3])/2;
            page.offsetX+=(curCenterX-oldCenterX);
            page.offsetY+=(curCenterY-oldCenterY);


            var oldDist = dist(oldtouches);
            var newDist = dist(curtouches);
            var scaleMultiplier = newDist/oldDist;
            var oldScale=page.scale;
            if ( evt.touches.length===2){
                page.scale = page.scale * scaleMultiplier;
                if (page.scale<scaleMin){
                    page.scale=scaleMin;
                } 
                if (page.scale>scaleMax){
                    page.scale=scaleMax;
                }
                //scale around center
                var dOffsetX=page.offsetX-curCenterX;
                var dOffsetY=page.offsetY-curCenterY;
                page.offsetX=dOffsetX*page.scale/oldScale+curCenterX;
                page.offsetY=dOffsetY*page.scale/oldScale+curCenterY;
            }

            oldtouches=curtouches;
            render();
            return;
        } else {
            oldtouches=null;
        }
        
        render();
/*
        if (evt.touches.length===1 && iconSelect===false && moved===false)
        {
            for (var i =0; i<evt.changedTouches.length; i++){
                var t= evt.changedTouches[0];

                var cx = t.clientX;
                var cy = t.clientY;

                var gx = Math.round(cx/cellSize);
                var gy = Math.round(cy/cellSize);

                if (cx!=oldX||cy!=oldY){
                    var x2=gx;
                    var x1=oldX;
                    var y2=gy;
                    var y1=oldY;

                    var dx=x2-x1;
                    var dy=y2-y1;

                    var l = Math.max(Math.abs(dx),Math.abs(dy));
                    dx = Math.sign(dx)*l;
                    dy = Math.sign(dy)*l;
                    x2=x1+dx;
                    y2=y1+dy;

                    ctx.beginPath();
                    ctx.moveTo(x1*cellSize+0.5,y1*cellSize+0.5);
                    ctx.lineTo(x2*cellSize+0.5,y2*cellSize+0.5);
                    ctx.strokeStyle="#888888"
                    ctx.stroke();
                }
            }
        }*/
    }

    var cellSize=55;

    var symbolCount=40;
    var highlightedglyphicon=-1;

    function drawSelectionPanel(select,x,y){
        var panelRows=5;
        var panelCols=Math.ceil(symbolCount/panelRows);

        var w = window.innerWidth;
        var h = window.innerHeight;

        var centerX = w/2;
        var centerY = h/2;

        var panelLeft = centerX-panelRows*cellSize/2;
        var panelRight = centerX+panelRows*cellSize/2;
        var panelTop = centerY-panelCols*cellSize/2;
        var panelBottom = centerY+panelCols*cellSize/2;
        panelTop+=cellSize/2;
        panelBottom+=cellSize/2;

        var ox = panelLeft;
        var oy = panelTop;

        //draw panel
        ctx.lineWidth = 1.0;   
        ctx.strokeStyle="#000000"
        ctx.fillStyle="#ffffff";

        ctx.beginPath();
        ctx.moveTo(panelLeft,panelTop);
        ctx.lineTo(panelRight,panelTop);
        ctx.lineTo(panelRight,panelBottom);
        ctx.lineTo(panelLeft,panelBottom);
        ctx.closePath();


        ctx.fill()
        ctx.stroke()


        var titleBarHeight=cellSize;
        var titleBarTop=panelTop-titleBarHeight;
        var titleBarBottom=panelTop;
        var titleBarIndent=0;
        var titleBarWidth=(panelRight-panelLeft);
        var titleBarLeft=panelLeft+titleBarIndent;
        var titleBarRight=titleBarLeft+titleBarWidth;


        
        //draw title bar
        ctx.strokeStyle="#000000"
        ctx.fillStyle="#ffffff";

        ctx.beginPath();
        ctx.moveTo(titleBarLeft,titleBarTop);
        ctx.lineTo(titleBarRight,titleBarTop);
        ctx.lineTo(titleBarRight,titleBarBottom);
        ctx.lineTo(titleBarLeft,titleBarBottom);
        ctx.closePath();


        ctx.fill()
        ctx.stroke()

        
        var dx=x-ox;
        var dy=y-oy;
        var w = panelRight-panelLeft;
        var h = panelBottom-panelTop;
        var gridx=-1;
        var gridy=-1;
        var highlightedglyphtext="";
        if (dx<0||dy<0||dx>=w||dy>=h){
            highlightedglyphicon=-1;
            //nothing
        } else {
            var xpos = Math.floor(dx/cellSize);
            var ypos = Math.floor(dy/cellSize);
            gridx=xpos;
            gridy=ypos;
            var i = xpos+ypos*panelRows;
            highlightedglyphicon=i;
            highlightedglyphtext=glyphNames[i];
            if (select===true){
                clickCell(oldX,oldY,i);
            }
        }
    
        //draw name
        ctx.lineWidth = 0;                        
        ctx.fillStyle="#000000";
        ctx.textAlign ="center";
        ctx.font = "38px helvetica";
        ctx.fillText(highlightedglyphtext,(titleBarLeft+titleBarRight)/2,titleBarBottom-14);
        if (highlightedglyphicon>=0){
            var titleBarMid = (titleBarTop+titleBarBottom)/2;

            drawIcon(
                titleBarLeft+cellSize/2,titleBarMid,highlightedglyphicon);
            drawIcon(
                titleBarRight-cellSize/2,titleBarMid,highlightedglyphicon);
        }

        var oldscale=page.scale;
        page.scale=1;
        for (var i=0;i<30;i++){            
            var ix = i%panelRows;
            var iy = Math.floor(i/panelRows);
            if (ix==gridx&&iy==gridy){
                ctx.globalalpha=1.0;
            }
            var mx = ox+ix*cellSize+cellSize/2;
            var my = oy+iy*cellSize+cellSize/2;
            if (i==highlightedglyphicon){
                ctx.fillStyle="#bbbbbb";
                ctx.beginPath();
                ctx.moveTo(mx-cellSize/2,my-cellSize/2);
                ctx.lineTo(mx+cellSize/2,my-cellSize/2);
                ctx.lineTo(mx+cellSize/2,my+cellSize/2);
                ctx.lineTo(mx-cellSize/2,my+cellSize/2);
                ctx.closePath();
                ctx.fill()
            }
            drawIcon(mx,my,i);

        }
        page.scale=oldscale;

        ctx.globalalpha=1.0;
    }
    function render(){            
      if (canvas.getContext) {

        ctx.canvas.width  = window.innerWidth;
        ctx.canvas.height = window.innerHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);    
        ctx.lineWidth = 1.0;                        

        //draw gui
        ctx.beginPath();
        var adjustX = page.offsetX-Math.floor(page.offsetX/(cellSize*page.scale))*(cellSize*page.scale);
        var adjustY = page.offsetY-Math.floor(page.offsetY/(cellSize*page.scale))*(cellSize*page.scale);
        adjustX/=2;
        adjustY/=2;
        for (var i=Math.floor(adjustX-cellSize*page.scale)+0.5;i<canvas.width;i+=cellSize*page.scale){ 
            ctx.moveTo(i+adjustX,0);
            ctx.lineTo(i+adjustX,ctx.canvas.height);
        }
        for (var j=Math.floor(adjustY-cellSize*page.scale)+0.5;j<canvas.height;j+=cellSize*page.scale){ 
            ctx.moveTo(0,j+adjustY);
            ctx.lineTo(ctx.canvas.width,j+adjustY);
        }

        var pc = 1-(scale-scaleMin)/(scaleMax-scaleMin);
        if (pc>1){
            pc=1;
        }
        if (pc<0){
            pc=0;
        }
        var a = Math.round(220+35*pc).toString(16);
        ctx.strokeStyle="#"+a+a+a;
        ctx.stroke();

        ctx.beginPath();
        for (var i=0;i<page.lines.length;i++){
            var l = page.lines[i];
            var x1 = Math.floor(page.offsetX+l[0]*cellSize*page.scale)+0.5;
            var y1 = Math.floor(page.offsetY+l[1]*cellSize*page.scale)+0.5;
            var x2 = Math.floor(page.offsetX+l[2]*cellSize*page.scale)+0.5;
            var y2 = Math.floor(page.offsetY+l[3]*cellSize*page.scale)+0.5;
            ctx.moveTo(x1,y1);
            ctx.lineTo(x2,y2);

            if (l[4]===1){
                var mx = (x1+x2)/2;
                var my = (y1+y2)/2;
                var t = Math.atan2(x2-x1,y2-y1);
                var dx = Math.sin(t+Math.PI/2);
                var dy = Math.cos(t+Math.PI/2);
                ctx.moveTo(
                    mx-dx*cellSize*page.scale/5,
                    my-dy*cellSize*page.scale/5);
                ctx.lineTo(
                    mx+dx*cellSize*page.scale/5,
                    my+dy*cellSize*page.scale/5);
            }
        }
        ctx.strokeStyle="#000000"
        ctx.stroke();

        for (var i=0;i<page.elements.length;i++){
            var e = page.elements[i];
            drawIcon(page.offsetX+e[0]*cellSize*page.scale,page.offsetY+e[1]*cellSize*page.scale,e[2]);        
        }

        {
            //window title bar
            ctx.strokeStyle="#000000";
            ctx.fillStyle="#ffffff";

            ctx.beginPath();
            ctx.moveTo(0,0);        
            ctx.lineTo(canvas.width,0);
            ctx.lineTo(canvas.width,20+cellSize);
            ctx.lineTo(0,20+cellSize);
            ctx.closePath();
            ctx.fill()
            ctx.stroke()

            //left button

            if (sketchBook.length===1&&PageEmpty()){
            } else {
                drawIcon(cellSize/2,20+cellSize/2,32);
            }

            ctx.fillStyle="#000000";
            ctx.textAlign ="center";
            ctx.font = "38px helvetica";
            ctx.fillText(page.sketchTitle,(canvas.width-cellSize)/2,20+cellSize-14);

            if (sketchBookIndex>0){
                drawIcon(canvas.width-3*cellSize/2,20+cellSize/2,30);
            } 
            if (!PageEmpty()){
                if (sketchBookIndex===sketchBook.length-1){
                    drawIcon(canvas.width-cellSize/2,20+cellSize/2,33);
                } else {
                    drawIcon(canvas.width-cellSize/2,20+cellSize/2,31);
                }
            }
        }

        //if (iconSelect&&minDistHit)
        {            
            drawSelectionPanel(false,mousex,mousey);
        }


        //draw top panel
      }
    }
</script>
    </head>
    <body onload="doStart()" onresize="render()">
        <canvas id="mainCanvas"  >
            
        </canvas>
    </body>

</html>
